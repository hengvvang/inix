# NixOS + Home Manager Flake é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ¯ é‡æ„ç›®æ ‡

é‡æ„ NixOS + Home Manager flake é…ç½®ï¼Œå®ç°ï¼š
- systemï¼ˆmySystemï¼‰å’Œ homeï¼ˆmyHomeï¼‰æ¨¡å—åŒ–ç»“æ„å’Œç”¨æ³•å®Œå…¨ä¸€è‡´
- æ‰€æœ‰æœåŠ¡å’ŒåŠŸèƒ½å‡é‡‡ç”¨ `.enable` æ ¼å¼
- æ‰€æœ‰æœåŠ¡åŠŸèƒ½é€‰é¡¹åœ¨ `system/default.nix` ä¸­å¯è§ä¸”é»˜è®¤å…³é—­
- åˆ é™¤æ‰€æœ‰æ•°æ®åº“ç›¸å…³é…ç½®
- å…¶ä»–æœåŠ¡å…¨éƒ¨æ¨¡å—åŒ–ä¸ºæ–‡ä»¶å¤¹ç»“æ„
- ä¾¿äºä¸»æœºè‡ªå®šä¹‰è¯¦ç»†é…ç½®
- é…ç½®é£æ ¼ç»Ÿä¸€ã€æ–‡æ¡£å®Œå–„
- å¯é€šè¿‡ `nixos-rebuild` å’Œ `home-manager` æ„å»º

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¨¡å—åŒ–ç»“æ„ç»Ÿä¸€

**System æœåŠ¡ç»“æ„**ï¼š
```
system/services/
â”œâ”€â”€ default.nix              # ç»Ÿä¸€å£°æ˜æ‰€æœ‰æœåŠ¡é€‰é¡¹
â”œâ”€â”€ docker/                  # Docker å®¹å™¨æœåŠ¡
â”‚   â”œâ”€â”€ default.nix         # é€‰é¡¹å£°æ˜ + å¯¼å…¥
â”‚   â”œâ”€â”€ core.nix            # æ ¸å¿ƒ Docker æœåŠ¡
â”‚   â”œâ”€â”€ compose.nix         # Docker Compose
â”‚   â”œâ”€â”€ buildkit.nix        # æ„å»ºå™¨å¢å¼º
â”‚   â”œâ”€â”€ registry.nix        # æœ¬åœ°é•œåƒä»“åº“
â”‚   â”œâ”€â”€ monitoring.nix      # ç›‘æ§å·¥å…·
â”‚   â””â”€â”€ security.nix        # å®‰å…¨å¢å¼º
â”œâ”€â”€ web/                     # Web æœåŠ¡
â”‚   â”œâ”€â”€ default.nix
â”‚   â””â”€â”€ nginx/
â”‚       â”œâ”€â”€ default.nix
â”‚       â”œâ”€â”€ core.nix        # åŸºç¡€ Nginx é…ç½®
â”‚       â”œâ”€â”€ ssl.nix         # SSL/TLS æ”¯æŒ
â”‚       â”œâ”€â”€ cache.nix       # ç¼“å­˜é…ç½®
â”‚       â””â”€â”€ security.nix    # å®‰å…¨å¢å¼º
â”œâ”€â”€ network/                 # ç½‘ç»œæœåŠ¡
â”‚   â”œâ”€â”€ default.nix
â”‚   â”œâ”€â”€ tailscale/          # VPN æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ default.nix
â”‚   â”‚   â””â”€â”€ core.nix
â”‚   â””â”€â”€ ssh/                # SSH è¿œç¨‹è®¿é—®
â”‚       â”œâ”€â”€ default.nix
â”‚       â””â”€â”€ core.nix
â”œâ”€â”€ media/                   # åª’ä½“æœåŠ¡
â”‚   â”œâ”€â”€ default.nix
â”‚   â”œâ”€â”€ jellyfin/           # åª’ä½“æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ default.nix
â”‚   â”‚   â””â”€â”€ core.nix
â”‚   â””â”€â”€ transmission/       # BT ä¸‹è½½å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ default.nix
â”‚       â””â”€â”€ core.nix
â”œâ”€â”€ storage/                 # å­˜å‚¨å’Œæ–‡ä»¶å…±äº«
â”‚   â”œâ”€â”€ default.nix
â”‚   â”œâ”€â”€ samba/              # Windows æ–‡ä»¶å…±äº«
â”‚   â”‚   â”œâ”€â”€ default.nix
â”‚   â”‚   â””â”€â”€ core.nix
â”‚   â”œâ”€â”€ nfs/                # Unix/Linux æ–‡ä»¶å…±äº«
â”‚   â”‚   â”œâ”€â”€ default.nix
â”‚   â”‚   â””â”€â”€ core.nix
â”‚   â””â”€â”€ syncthing/          # ç‚¹å¯¹ç‚¹æ–‡ä»¶åŒæ­¥
â”‚       â”œâ”€â”€ default.nix
â”‚       â””â”€â”€ core.nix
â””â”€â”€ hardware/                # ç¡¬ä»¶å’Œç³»ç»ŸæœåŠ¡
    â”œâ”€â”€ default.nix
    â”œâ”€â”€ printing/           # æ‰“å°å’Œæ‰«æ
    â”‚   â”œâ”€â”€ default.nix
    â”‚   â””â”€â”€ core.nix
    â”œâ”€â”€ bluetooth/          # è“ç‰™è¿æ¥
    â”‚   â”œâ”€â”€ default.nix
    â”‚   â””â”€â”€ core.nix
    â””â”€â”€ sound/              # éŸ³é¢‘ç³»ç»Ÿ
        â”œâ”€â”€ default.nix
        â””â”€â”€ core.nix
```

### 2. ç»Ÿä¸€çš„ `.enable` æ ¼å¼

æ‰€æœ‰æœåŠ¡å’ŒåŠŸèƒ½éƒ½é‡‡ç”¨ç»Ÿä¸€çš„ `.enable` å¼€å…³æ ¼å¼ï¼š

```nix
mySystem.services = {
  # Docker å®¹å™¨æœåŠ¡
  docker = {
    enable = false;                    # åŸºç¡€ Docker æœåŠ¡
    compose.enable = false;            # Docker Compose
    buildkit.enable = false;           # æ„å»ºå™¨å¢å¼º
    registry.enable = false;           # æœ¬åœ°é•œåƒä»“åº“
    monitoring.enable = false;         # ç›‘æ§å·¥å…·
    security.enable = false;           # å®‰å…¨å¢å¼º
  };
  
  # ç½‘ç»œæœåŠ¡
  network = {
    tailscale.enable = false;          # VPN æœåŠ¡
    ssh.enable = false;                # SSH è¿œç¨‹è®¿é—®
  };
  
  # Web æœåŠ¡
  web.nginx = {
    enable = false;                    # Nginx åŸºç¡€æœåŠ¡
    ssl.enable = false;                # SSL/TLS æ”¯æŒ
    cache.enable = false;              # ç¼“å­˜é…ç½®
    security.enable = false;           # å®‰å…¨å¢å¼º
  };
  
  # ç¡¬ä»¶æœåŠ¡
  hardware = {
    printing.enable = false;           # æ‰“å°æœåŠ¡
    bluetooth.enable = false;          # è“ç‰™æ”¯æŒ
    sound.enable = false;              # éŸ³é¢‘ç³»ç»Ÿ
  };
  
  # å­˜å‚¨æœåŠ¡
  storage = {
    samba.enable = false;              # Windows æ–‡ä»¶å…±äº«
    nfs.enable = false;                # NFS ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ
    syncthing.enable = false;          # æ–‡ä»¶åŒæ­¥
  };
  
  # åª’ä½“æœåŠ¡
  media = {
    jellyfin.enable = false;           # åª’ä½“æœåŠ¡å™¨
    transmission.enable = false;       # BT ä¸‹è½½
  };
};
```

### 3. æ•°æ®åº“é…ç½®æ¸…ç†

âœ… **å·²åˆ é™¤çš„æ•°æ®åº“ç›¸å…³é…ç½®**ï¼š
- `system/services/databases/` æ•´ä¸ªç›®å½•
- PostgreSQL, Redis, MySQL, MongoDB åŠå…¶æ‰€æœ‰å­æ¨¡å—
- æ‰€æœ‰æ•°æ®åº“ç›¸å…³çš„ imports å’Œé€‰é¡¹å®šä¹‰
- ä» `system/services/default.nix` ä¸­ç§»é™¤æ•°æ®åº“ç›¸å…³é€‰é¡¹

### 4. ä¸»æœºé…ç½®ç¤ºä¾‹

**hosts/laptop/configuration.nix** - å±•ç¤ºå¦‚ä½•æŒ‰éœ€å¯ç”¨æœåŠ¡ï¼š

```nix
mySystem = {
  desktop.cosmic.enable = true;       # æ¡Œé¢ç¯å¢ƒ
  hardware.enable = true;             # ç¡¬ä»¶é…ç½®
  users.enable = true;                # ç”¨æˆ·é…ç½®
  packages.enable = true;             # ç³»ç»ŸåŒ…
  
  services = {
    # Docker å®¹å™¨æœåŠ¡ - å®Œæ•´åŠŸèƒ½
    docker = {
      enable = true;                    # å¯ç”¨ Docker æ ¸å¿ƒ
      compose.enable = true;            # å¯ç”¨ Docker Compose
      buildkit.enable = true;           # å¯ç”¨æ„å»ºå™¨
      monitoring.enable = true;         # å¯ç”¨ç›‘æ§
    };
    
    # ç½‘ç»œæœåŠ¡
    network = {
      ssh.enable = true;                # SSH æœåŠ¡
      tailscale.enable = true;          # VPN æœåŠ¡
    };
    
    # Web æœåŠ¡
    web.nginx.enable = true;            # Nginx æœåŠ¡å™¨
    
    # ç¡¬ä»¶æœåŠ¡
    hardware = {
      sound.enable = true;              # éŸ³é¢‘ç³»ç»Ÿ
      bluetooth.enable = true;          # è“ç‰™æ”¯æŒ
    };
  };
  
  # æœ¬åœ°åŒ–é…ç½®
  localization = {
    timeZone.shanghai.enable = true;    # ä¸­å›½æ—¶åŒº
    inputMethod.fcitx5.enable = true;   # ä¸­æ–‡è¾“å…¥æ³•
  };
};
```

### 5. æµ‹è¯•éªŒè¯

âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡**ï¼š
- `nix build .#nixosConfigurations.hengvvang.config.system.build.toplevel --dry-run` âœ“
- `nix build .#homeConfigurations.hengvvang.activationPackage --dry-run` âœ“
- `nix flake check` âœ“

### 6. Git æäº¤å†å²

æ‰€æœ‰æ›´æ”¹å·²æŒ‰æ¨¡å—åˆ†åˆ«æäº¤ï¼Œä¿æŒæ¸…æ™°çš„ç‰ˆæœ¬å†å²ï¼š
- åˆ é™¤æ•°æ®åº“ç›¸å…³é…ç½®
- é‡æ„å„æœåŠ¡ä¸ºæ–‡ä»¶å¤¹ç»“æ„
- ç»Ÿä¸€é€‰é¡¹å£°æ˜å’Œå¯¼å…¥
- ä¿®å¤é…ç½®é”™è¯¯å’Œé‡å¤å®šä¹‰

## ğŸš€ ä½¿ç”¨è¯´æ˜

### æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»º NixOS ç³»ç»Ÿé…ç½®
sudo nixos-rebuild switch --flake .#hengvvang

# æ„å»º Home Manager é…ç½®
home-manager switch --flake .#hengvvang

# æµ‹è¯•é…ç½®ï¼ˆä¸éƒ¨ç½²ï¼‰
nix build .#nixosConfigurations.hengvvang.config.system.build.toplevel --dry-run
nix build .#homeConfigurations.hengvvang.activationPackage --dry-run
```

### è‡ªå®šä¹‰ä¸»æœºé…ç½®

1. **å¤åˆ¶ laptop ä¸»æœºé…ç½®**ï¼š
   ```bash
   cp -r hosts/laptop hosts/æ–°ä¸»æœºå
   ```

2. **ä¿®æ”¹ä¸»æœºé…ç½®**ï¼š
   - æ›´æ–° `hosts/æ–°ä¸»æœºå/configuration.nix`
   - æŒ‰éœ€å¯ç”¨/ç¦ç”¨æœåŠ¡
   - è‡ªå®šä¹‰è¯¦ç»†å‚æ•°

3. **æ·»åŠ åˆ° flake.nix**ï¼š
   ```nix
   nixosConfigurations.æ–°ä¸»æœºå = nixpkgs.lib.nixosSystem {
     # ...
   };
   ```

### æ‰©å±•æ–°æœåŠ¡

1. **åˆ›å»ºæœåŠ¡ç›®å½•**ï¼š
   ```bash
   mkdir -p system/services/åˆ†ç±»/æ–°æœåŠ¡
   ```

2. **åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š
   - `default.nix` - é€‰é¡¹å£°æ˜å’Œå¯¼å…¥
   - `core.nix` - å…·ä½“æœåŠ¡é…ç½®

3. **æ›´æ–°çˆ¶çº§é…ç½®**ï¼š
   - åœ¨ `system/services/åˆ†ç±»/default.nix` ä¸­æ·»åŠ å¯¼å…¥
   - åœ¨ `system/services/default.nix` ä¸­å£°æ˜é€‰é¡¹

## ğŸ“‹ ç‰¹æ€§ä¼˜åŠ¿

- âœ… **ç»“æ„ç»Ÿä¸€**ï¼šsystem å’Œ home é‡‡ç”¨å®Œå…¨ä¸€è‡´çš„æ¨¡å—åŒ–ç»“æ„
- âœ… **é…ç½®ç®€æ´**ï¼šæ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯ `.enable` å¼€å…³ï¼Œé»˜è®¤å…³é—­
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°æœåŠ¡åªéœ€æŒ‰æ¨¡å¼æ·»åŠ æ–‡ä»¶å¤¹å’Œé…ç½®
- âœ… **ä¸»æœºè‡ªå®šä¹‰**ï¼šåœ¨ä¸»æœºé…ç½®ä¸­è½»æ¾å¯ç”¨éœ€è¦çš„åŠŸèƒ½
- âœ… **æ–‡æ¡£å®Œå–„**ï¼šæ¯ä¸ªæœåŠ¡éƒ½æœ‰æ¸…æ™°çš„é€‰é¡¹è¯´æ˜
- âœ… **æµ‹è¯•é€šè¿‡**ï¼šæ‰€æœ‰é…ç½®éƒ½é€šè¿‡äº†æ„å»ºæµ‹è¯•

## ğŸ‰ é‡æ„å®Œæˆï¼

ç°åœ¨æ‚¨çš„ NixOS + Home Manager flake é…ç½®å·²ç»å®Œå…¨é‡æ„å®Œæˆï¼Œå…·æœ‰ï¼š
- ç»Ÿä¸€çš„æ¨¡å—åŒ–ç»“æ„
- æ¸…æ™°çš„æœåŠ¡ç»„ç»‡
- ç®€æ´çš„é…ç½®æ–¹å¼
- å®Œå–„çš„æ–‡æ¡£å’Œç¤ºä¾‹
- å¯é çš„æ„å»ºæµ‹è¯•

å¯ä»¥å¼€å§‹ä½¿ç”¨æ–°çš„é…ç½®ç»“æ„äº†ï¼
