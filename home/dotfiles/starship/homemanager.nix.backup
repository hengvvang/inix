{ config, lib, pkgs, ... }:

{
  config = lib.mkIf (config.myHome.dotfiles.enable && config.myHome.dotfiles.starship.enable && config.myHome.dotfiles.starship.method == "homemanager") {
    # Starship æç¤ºç¬¦å®Œæ•´é…ç½®
    programs.starship = {
      # ===== åŸºç¡€é…ç½® =====
      enable = true;
      package = pkgs.starship;  # æŒ‡å®š Starship åŒ…
      
      # ===== Shell é›†æˆé…ç½® =====
      # å¯ç”¨å„ç§ shell çš„é›†æˆæ”¯æŒ
      enableBashIntegration = true;    # Bash é›†æˆ
      enableFishIntegration = true;    # Fish é›†æˆ
      enableZshIntegration = true;     # Zsh é›†æˆ
      enableNushellIntegration = false; # Nushell é›†æˆï¼Œé»˜è®¤ç¦ç”¨
      enableIonIntegration = false;    # Ion é›†æˆï¼Œé»˜è®¤ç¦ç”¨
      
      # ===== é«˜çº§åŠŸèƒ½é…ç½® =====
      enableInteractive = true;        # ä»…åœ¨äº¤äº’å¼ shell ä¸­å¯ç”¨
      enableTransience = false;        # ç¬æ€æç¤ºåŠŸèƒ½ï¼Œæ›¿æ¢æ—§æç¤ºä¸ºç®€åŒ–å­—ç¬¦ä¸²
      
      # ===== ä¸»è¦é…ç½®é€‰é¡¹ =====
      settings = {
        # ===== å…¨å±€æç¤ºç¬¦è®¾ç½® =====
        # æç¤ºç¬¦åŸºæœ¬è¡Œä¸º
        add_newline = true;             # åœ¨æç¤ºç¬¦é—´æ’å…¥ç©ºè¡Œï¼Œæé«˜å¯è¯»æ€§
        scan_timeout = 30;              # æ‰«ææ–‡ä»¶è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¹³è¡¡æ€§èƒ½å’Œå“åº”
        command_timeout = 500;          # å‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        follow_symlinks = true;         # æ˜¯å¦è·Ÿéšç¬¦å·é“¾æ¥æ£€æŸ¥ç›®å½•
        
        # ===== æç¤ºç¬¦æ ¼å¼é…ç½® =====
        # è‡ªå®šä¹‰æç¤ºç¬¦å¸ƒå±€ï¼ˆä½¿ç”¨é»˜è®¤æ ¼å¼ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
        format = lib.concatStrings [
          "$username"        # ç”¨æˆ·åï¼ˆåœ¨ç‰¹å®šæ¡ä»¶ä¸‹æ˜¾ç¤ºï¼‰
          "$hostname"        # ä¸»æœºåï¼ˆSSH è¿æ¥æ—¶æ˜¾ç¤ºï¼‰
          "$directory"       # å½“å‰ç›®å½•
          "$git_branch"      # Git åˆ†æ”¯
          "$git_status"      # Git çŠ¶æ€
          "$python"          # Python ç‰ˆæœ¬
          "$nodejs"          # Node.js ç‰ˆæœ¬
          "$rust"            # Rust ç‰ˆæœ¬
          "$java"            # Java ç‰ˆæœ¬
          "$golang"          # Go ç‰ˆæœ¬
          "$package"         # åŒ…ç‰ˆæœ¬
          "$cmd_duration"    # å‘½ä»¤æ‰§è¡Œæ—¶é—´
          "$line_break"      # æ¢è¡Œ
          "$character"       # æç¤ºç¬¦å­—ç¬¦
        ];
        
        # ===== å³ä¾§æç¤ºç¬¦ =====
        right_format = lib.concatStrings [
          "$time"           # æ—¶é—´æ˜¾ç¤º
        ];
        
        # ===== å­—ç¬¦æ¨¡å—é…ç½® =====
        character = {
          success_symbol = "[â¯](bold green)";      # æˆåŠŸæ—¶çš„æç¤ºç¬¦
          error_symbol = "[â¯](bold red)";          # é”™è¯¯æ—¶çš„æç¤ºç¬¦
          vimcmd_symbol = "[â®](bold green)";       # Vim å‘½ä»¤æ¨¡å¼
          vimcmd_visual_symbol = "[â®](bold yellow)"; # Vim å¯è§†æ¨¡å¼
        };
        
        # ===== ç›®å½•æ¨¡å—é…ç½® =====
        directory = {
          truncation_length = 3;          # ç›®å½•æˆªæ–­é•¿åº¦
          truncate_to_repo = true;        # æˆªæ–­åˆ° Git ä»“åº“æ ¹ç›®å½•
          format = "[$path]($style)[$read_only]($read_only_style) ";
          style = "bold cyan";            # ç›®å½•æ ·å¼
          read_only = "ğŸ”’";              # åªè¯»ç›®å½•æ ‡è¯†
          read_only_style = "red";        # åªè¯»æ ·å¼
          home_symbol = "~";              # å®¶ç›®å½•ç¬¦å·
          use_os_path_sep = true;         # ä½¿ç”¨ç³»ç»Ÿè·¯å¾„åˆ†éš”ç¬¦
        };
        
        # ===== Git åˆ†æ”¯é…ç½® =====
        git_branch = {
          always_show_remote = false;     # ä¸æ€»æ˜¯æ˜¾ç¤ºè¿œç¨‹åˆ†æ”¯
          format = "on [$symbol$branch(:$remote_branch)]($style) ";
          symbol = " ";                  # Git åˆ†æ”¯ç¬¦å·
          style = "bold purple";          # Git åˆ†æ”¯æ ·å¼
          truncation_length = 20;         # åˆ†æ”¯åæˆªæ–­é•¿åº¦
          truncation_symbol = "â€¦";        # æˆªæ–­ç¬¦å·
          only_attached = false;          # åœ¨åˆ†ç¦» HEAD æ—¶ä¹Ÿæ˜¾ç¤º
        };
        
        # ===== Git çŠ¶æ€é…ç½® =====
        git_status = {
          format = "([$all_status$ahead_behind]($style) )";
          style = "bold red";             # Git çŠ¶æ€æ ·å¼
          # çŠ¶æ€ç¬¦å·é…ç½®
          conflicted = "=";               # å†²çªçŠ¶æ€
          ahead = "â‡¡";                   # é¢†å…ˆçŠ¶æ€
          behind = "â‡£";                  # è½åçŠ¶æ€
          diverged = "â‡•";                # åˆ†æ­§çŠ¶æ€
          up_to_date = "âœ“";              # æœ€æ–°çŠ¶æ€
          untracked = "?";               # æœªè·Ÿè¸ªæ–‡ä»¶
          stashed = "$";                 # å­˜å‚¨çŠ¶æ€
          modified = "!";                # ä¿®æ”¹çŠ¶æ€
          staged = "+";                  # æš‚å­˜çŠ¶æ€
          renamed = "Â»";                 # é‡å‘½åçŠ¶æ€
          deleted = "âœ˜";                 # åˆ é™¤çŠ¶æ€
        };
        
        # ===== å‘½ä»¤æ‰§è¡Œæ—¶é—´é…ç½® =====
        cmd_duration = {
          min_time = 2000;               # æœ€å°æ˜¾ç¤ºæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
          format = "took [$duration]($style) ";
          style = "bold yellow";          # æ‰§è¡Œæ—¶é—´æ ·å¼
          show_milliseconds = false;      # ä¸æ˜¾ç¤ºæ¯«ç§’
        };
        
        # ===== æ—¶é—´æ¨¡å—é…ç½® =====
        time = {
          disabled = false;               # å¯ç”¨æ—¶é—´æ˜¾ç¤º
          format = "at [$time]($style) "; # æ—¶é—´æ ¼å¼
          style = "bold blue";            # æ—¶é—´æ ·å¼
          time_format = "%H:%M:%S";       # 24å°æ—¶æ ¼å¼
          utc_time_offset = "local";      # ä½¿ç”¨æœ¬åœ°æ—¶åŒº
        };
        
        # ===== ç¼–ç¨‹è¯­è¨€æ¨¡å—é…ç½® =====
        # Python é…ç½®
        python = {
          format = "via [ğŸ $version($virtualenv )]($style)";
          style = "yellow bold";
          detect_extensions = [ "py" ];   # æ£€æµ‹ Python æ–‡ä»¶
          detect_files = [ "requirements.txt" "pyproject.toml" ".python-version" ];
          pyenv_version_name = false;     # ä¸æ˜¾ç¤º pyenv ç‰ˆæœ¬å
        };
        
        # Node.js é…ç½®
        nodejs = {
          format = "via [ $version]($style) ";
          style = "bold green";
          detect_extensions = [ "js" "mjs" "cjs" "ts" ];
          detect_files = [ "package.json" ".node-version" ".nvmrc" ];
        };
        
        # Rust é…ç½®
        rust = {
          format = "via [ğŸ¦€ $version]($style) ";
          style = "bold red";
          detect_extensions = [ "rs" ];
          detect_files = [ "Cargo.toml" ];
        };
        
        # Go é…ç½®
        golang = {
          format = "via [ğŸ¹ $version]($style) ";
          style = "bold cyan";
          detect_extensions = [ "go" ];
          detect_files = [ "go.mod" "go.sum" ".go-version" ];
        };
        
        # Java é…ç½®
        java = {
          format = "via [â˜• $version]($style) ";
          style = "red dimmed";
          detect_extensions = [ "java" "class" "jar" ];
          detect_files = [ "pom.xml" "build.gradle.kts" ".java-version" ];
        };
        
        # ===== å…¶ä»–æœ‰ç”¨æ¨¡å—é…ç½® =====
        # åŒ…ç‰ˆæœ¬é…ç½®
        package = {
          format = "is [ğŸ“¦ $version]($style) ";
          style = "bold 208";
          display_private = false;        # ä¸æ˜¾ç¤ºç§æœ‰åŒ…
        };
        
        # ç”¨æˆ·åé…ç½®
        username = {
          style_user = "white bold";      # æ™®é€šç”¨æˆ·æ ·å¼
          style_root = "black bold";      # root ç”¨æˆ·æ ·å¼
          format = "[$user]($style) in ";
          disabled = false;               # åœ¨ç‰¹å®šæ¡ä»¶ä¸‹æ˜¾ç¤º
          show_always = false;            # ä¸æ€»æ˜¯æ˜¾ç¤º
        };
        
        # ä¸»æœºåé…ç½®
        hostname = {
          ssh_only = true;                # ä»…åœ¨ SSH è¿æ¥æ—¶æ˜¾ç¤º
          format = "on [$hostname]($style) ";
          style = "bold dimmed green";
          disabled = false;
        };
        
        # ===== æ€§èƒ½ä¼˜åŒ–é…ç½® =====
        # ç¦ç”¨ä¸€äº›ä¸å¸¸ç”¨çš„æ¨¡å—ä»¥æé«˜æ€§èƒ½
        azure.disabled = true;           # ç¦ç”¨ Azure æ¨¡å—
        aws.disabled = true;             # ç¦ç”¨ AWS æ¨¡å—
        gcloud.disabled = true;          # ç¦ç”¨ Google Cloud æ¨¡å—
        kubernetes.disabled = true;       # ç¦ç”¨ Kubernetes æ¨¡å—
        docker_context.disabled = true;  # ç¦ç”¨ Docker ä¸Šä¸‹æ–‡
        
        # å…¶ä»–è¯­è¨€æ¨¡å—ï¼ˆæ ¹æ®éœ€è¦å¯ç”¨/ç¦ç”¨ï¼‰
        c.disabled = true;               # ç¦ç”¨ C æ¨¡å—
        cpp.disabled = true;             # ç¦ç”¨ C++ æ¨¡å—
        dotnet.disabled = true;          # ç¦ç”¨ .NET æ¨¡å—
        php.disabled = true;             # ç¦ç”¨ PHP æ¨¡å—
        ruby.disabled = true;            # ç¦ç”¨ Ruby æ¨¡å—
        lua.disabled = true;             # ç¦ç”¨ Lua æ¨¡å—
        julia.disabled = true;           # ç¦ç”¨ Julia æ¨¡å—
        kotlin.disabled = true;          # ç¦ç”¨ Kotlin æ¨¡å—
        scala.disabled = true;           # ç¦ç”¨ Scala æ¨¡å—
        swift.disabled = true;           # ç¦ç”¨ Swift æ¨¡å—
        
        # ===== ç³»ç»Ÿä¿¡æ¯æ¨¡å— =====
        # å†…å­˜ä½¿ç”¨ï¼ˆé»˜è®¤ç¦ç”¨ï¼Œæ€§èƒ½è€ƒè™‘ï¼‰
        memory_usage = {
          disabled = true;               # ç¦ç”¨å†…å­˜ä½¿ç”¨æ˜¾ç¤º
          threshold = 75;                # å†…å­˜ä½¿ç”¨é˜ˆå€¼
          format = "via $symbol [\${ram}]($style) ";
          symbol = "ğŸ";
        };
        
        # ç”µæ± çŠ¶æ€ï¼ˆç¬”è®°æœ¬ç”µè„‘æœ‰ç”¨ï¼‰
        battery = {
          full_symbol = "ğŸ”‹ ";
          charging_symbol = "âš¡ï¸ ";
          discharging_symbol = "ğŸ’€ ";
          format = "[$symbol$percentage]($style) ";
          disabled = false;              # å¯ç”¨ç”µæ± çŠ¶æ€
          
          # ç”µæ± æ˜¾ç¤ºé˜ˆå€¼é…ç½®
          display = [
            {
              threshold = 10;
              style = "bold red";
            }
            {
              threshold = 30;
              style = "bold yellow";
            }
          ];
        };
        
        # Shell æŒ‡ç¤ºå™¨ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
        shell = {
          disabled = true;               # ç¦ç”¨ shell æŒ‡ç¤ºå™¨
          bash_indicator = "bsh";
          fish_indicator = "fsh";
          zsh_indicator = "zsh";
          format = "[$indicator]($style) ";
          style = "white bold";
        };
      };
    };
  };
}
