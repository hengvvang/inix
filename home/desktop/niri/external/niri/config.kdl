// Niri 配置文件
// 基于 KDL 格式，实时重载

// ========== 输入设备配置 ==========
input {
    // 键盘配置
    keyboard {
        xkb {
            // 键盘布局 (美式英语)
            layout "us"
            // 可选：变体设置
            // variant ""
            // 可选：选项设置
            // options "grp:alt_shift_toggle"
        }
        
        // 按键重复
        repeat-delay 600
        repeat-rate 25
        
        // Caps Lock 映射为 Escape
        // xkb {
        //     options "caps:escape"
        // }
    }
    
    // 触摸板配置
    touchpad {
        // 启用自然滚动
        natural-scroll true
        
        // 启用轻触点击
        tap true
        
        // 启用拖拽
        drag true
        
        // 启用拖拽锁定
        drag-lock false
        
        // 禁用触摸时禁用触摸板
        disable-while-typing true
        
        // 点击方法: button-areas, clickfinger
        click-method "clickfinger"
        
        // 滚动方法: two-finger, edge, on-button-down
        scroll-method "two-finger"
        
        // 加速度配置
        accel-speed 0.2
        accel-profile "adaptive"
    }
    
    // 鼠标配置
    mouse {
        // 鼠标加速度
        accel-speed 0.0
        accel-profile "flat"
        
        // 自然滚动
        natural-scroll false
    }
    
    // 平板电脑配置 (如果有)
    tablet {
        // 映射到输出
        // map-to-output "eDP-1"
    }
    
    // 启用焦点跟随鼠标
    focus-follows-mouse true
    
    // 工作区切换跟随鼠标
    workspace-auto-back-and-forth true
}

// ========== 输出设备配置 ==========
// 示例输出配置，根据实际显示器调整
output "eDP-1" {
    // 模式设置
    mode "1920x1080@60.000"
    
    // 位置设置
    position x=0 y=0
    
    // 缩放设置
    scale 1.0
    
    // 旋转设置: normal, 90, 180, 270
    transform "normal"
    
    // 变量刷新率
    variable-refresh-rate true
}

// 外接显示器示例
// output "HDMI-A-1" {
//     mode "2560x1440@144.000"
//     position x=1920 y=0
//     scale 1.0
//     transform "normal"
// }

// ========== 布局配置 ==========
layout {
    // 间隙设置
    gaps 16
    
    // 边框设置  
    border {
        width 2
        active-color "#7c3aed"
        inactive-color "#374151"
        
        // 渐变边框 (可选)
        active-gradient from="#7c3aed" to="#06b6d4" angle=45
        inactive-gradient from="#374151" to="#1f2937" angle=45
    }
    
    // 聚焦环设置
    focus-ring {
        width 4
        active-color "#7c3aed"
        inactive-color "#6b7280"
        
        // 聚焦环渐变 (可选)
        active-gradient from="#7c3aed" to="#06b6d4" angle=45
        inactive-gradient from="#6b7280" to="#374151" angle=45
    }
    
    // 预设宽度
    preset-column-widths {
        proportion 0.33333
        proportion 0.5
        proportion 0.66667
        fixed 1200
        fixed 800
    }
    
    // 预设高度  
    preset-window-heights {
        proportion 0.33333
        proportion 0.5
        proportion 0.66667
        fixed 600
    }
    
    // 默认列宽
    default-column-width { proportion 0.5; }
    
    // 中央对齐列
    center-focused-column "never"
    
    // 插入新窗口的位置
    insert-hint "end"
    
    // 当只有一个窗口时始终居中
    center-focused-column "on-overflow"
}

// ========== 快捷键绑定 ==========
binds {
    // 修饰键定义
    // Mod (Super/Windows 键)
    
    // ===== 应用程序启动 =====
    "Mod+T" { spawn "ghostty"; }
    "Mod+D" { spawn "fuzzel"; }
    "Mod+E" { spawn "nautilus"; }
    "Mod+B" { spawn "firefox"; }
    "Mod+C" { spawn "code"; }
    
    // ===== 系统控制 =====
    "Mod+Q" { close-window; }
    "Mod+Shift+E" { quit; }
    "Mod+Shift+R" { reload-config; }
    
    // 屏幕锁定
    "Super+Alt+L" { spawn "swaylock"; }
    
    // ===== 窗口导航 =====
    // 左右切换列
    "Mod+H" { focus-column-left; }
    "Mod+L" { focus-column-right; }
    "Mod+Left" { focus-column-left; }
    "Mod+Right" { focus-column-right; }
    
    // 上下切换窗口
    "Mod+J" { focus-window-down; }
    "Mod+K" { focus-window-up; }
    "Mod+Down" { focus-window-down; }
    "Mod+Up" { focus-window-up; }
    
    // ===== 窗口移动 =====
    // 移动列
    "Mod+Ctrl+H" { move-column-left; }
    "Mod+Ctrl+L" { move-column-right; }
    "Mod+Ctrl+Left" { move-column-left; }
    "Mod+Ctrl+Right" { move-column-right; }
    
    // 移动窗口
    "Mod+Ctrl+J" { move-window-down; }
    "Mod+Ctrl+K" { move-window-up; }
    "Mod+Ctrl+Down" { move-window-down; }
    "Mod+Ctrl+Up" { move-window-up; }
    
    // ===== 监视器切换 =====
    "Mod+Shift+H" { focus-monitor-left; }
    "Mod+Shift+L" { focus-monitor-right; }
    "Mod+Shift+J" { focus-monitor-down; }
    "Mod+Shift+K" { focus-monitor-up; }
    
    // 移动到监视器
    "Mod+Ctrl+Shift+H" { move-column-to-monitor-left; }
    "Mod+Ctrl+Shift+L" { move-column-to-monitor-right; }
    "Mod+Ctrl+Shift+J" { move-column-to-monitor-down; }
    "Mod+Ctrl+Shift+K" { move-column-to-monitor-up; }
    
    // ===== 工作区切换 =====
    "Mod+U" { focus-workspace-down; }
    "Mod+I" { focus-workspace-up; }
    "Mod+PageDown" { focus-workspace-down; }
    "Mod+PageUp" { focus-workspace-up; }
    
    // 移动到工作区
    "Mod+Ctrl+U" { move-column-to-workspace-down; }
    "Mod+Ctrl+I" { move-column-to-workspace-up; }
    "Mod+Ctrl+PageDown" { move-column-to-workspace-down; }
    "Mod+Ctrl+PageUp" { move-column-to-workspace-up; }
    
    // 工作区移动
    "Mod+Shift+U" { move-workspace-down; }
    "Mod+Shift+I" { move-workspace-up; }
    "Mod+Shift+PageDown" { move-workspace-down; }
    "Mod+Shift+PageUp" { move-workspace-up; }
    
    // ===== 数字工作区 =====
    "Mod+1" { focus-workspace 1; }
    "Mod+2" { focus-workspace 2; }
    "Mod+3" { focus-workspace 3; }
    "Mod+4" { focus-workspace 4; }
    "Mod+5" { focus-workspace 5; }
    "Mod+6" { focus-workspace 6; }
    "Mod+7" { focus-workspace 7; }
    "Mod+8" { focus-workspace 8; }
    "Mod+9" { focus-workspace 9; }
    "Mod+0" { focus-workspace 10; }
    
    // 移动窗口到数字工作区
    "Mod+Ctrl+1" { move-column-to-workspace 1; }
    "Mod+Ctrl+2" { move-column-to-workspace 2; }
    "Mod+Ctrl+3" { move-column-to-workspace 3; }
    "Mod+Ctrl+4" { move-column-to-workspace 4; }
    "Mod+Ctrl+5" { move-column-to-workspace 5; }
    "Mod+Ctrl+6" { move-column-to-workspace 6; }
    "Mod+Ctrl+7" { move-column-to-workspace 7; }
    "Mod+Ctrl+8" { move-column-to-workspace 8; }
    "Mod+Ctrl+9" { move-column-to-workspace 9; }
    "Mod+Ctrl+0" { move-column-to-workspace 10; }
    
    // ===== 列操作 =====
    "Mod+Comma" { consume-window-into-column; }
    "Mod+Period" { expel-window-from-column; }
    "Mod+BracketLeft" { consume-or-expel-window-left; }
    "Mod+BracketRight" { consume-or-expel-window-right; }
    
    // ===== 窗口大小调整 =====
    "Mod+R" { switch-preset-column-width; }
    "Mod+Shift+R" { switch-preset-window-height; }
    "Mod+F" { maximize-column; }
    "Mod+Shift+F" { fullscreen-window; }
    "Mod+Ctrl+R" { reset-window-height; }
    
    // 大小调整
    "Mod+Minus" { set-column-width "-10%"; }
    "Mod+Equal" { set-column-width "+10%"; }
    "Mod+Shift+Minus" { set-window-height "-10%"; }
    "Mod+Shift+Equal" { set-window-height "+10%"; }
    
    // 居中列
    "Mod+Ctrl+C" { center-column; }
    
    // ===== 浮动窗口 =====
    "Mod+V" { toggle-window-floating; }
    "Mod+Shift+V" { switch-floating-layout; }
    
    // ===== 截图 =====
    "Print" { spawn "sh" "-c" "~/.config/niri/scripts/screenshot.sh area"; }
    "Alt+Print" { spawn "sh" "-c" "~/.config/niri/scripts/screenshot.sh window"; }
    "Ctrl+Print" { spawn "sh" "-c" "~/.config/niri/scripts/screenshot.sh screen"; }
    "Shift+Print" { spawn "sh" "-c" "~/.config/niri/scripts/screenshot.sh area-to-clipboard"; }
    
    // ===== 媒体键 =====
    "XF86AudioRaiseVolume" { spawn "sh" "-c" "~/.config/niri/scripts/volume.sh up"; }
    "XF86AudioLowerVolume" { spawn "sh" "-c" "~/.config/niri/scripts/volume.sh down"; }
    "XF86AudioMute" { spawn "sh" "-c" "~/.config/niri/scripts/volume.sh toggle"; }
    "XF86AudioMicMute" { spawn "pamixer" "--default-source" "--toggle-mute"; }
    
    // 亮度控制
    "XF86MonBrightnessUp" { spawn "sh" "-c" "~/.config/niri/scripts/brightness.sh up"; }
    "XF86MonBrightnessDown" { spawn "sh" "-c" "~/.config/niri/scripts/brightness.sh down"; }
    
    // 媒体播放控制
    "XF86AudioPlay" { spawn "playerctl" "play-pause"; }
    "XF86AudioPause" { spawn "playerctl" "pause"; }
    "XF86AudioNext" { spawn "playerctl" "next"; }
    "XF86AudioPrev" { spawn "playerctl" "previous"; }
    
    // ===== 其他工具 =====
    // 剪贴板历史
    "Mod+Shift+V" { spawn "cliphist" "list" "|" "fuzzel" "--dmenu" "|" "cliphist" "decode" "|" "wl-copy"; }
    
    // 颜色选择器 (如果需要)
    // "Mod+Shift+C" { spawn "hyprpicker" "-a"; }
    
    // 显示帮助
    "Mod+Shift+Slash" { show-hotkey-overlay; }
    
    // 概览模式
    "Mod+Tab" { overview; }
    
    // 应用切换器
    "Alt+Tab" { switch-focus-next; }
    "Alt+Shift+Tab" { switch-focus-previous; }
    
    // 切换显示器电源
    "Mod+Shift+P" { spawn "sh" "-c" "~/.config/niri/scripts/toggle-display.sh"; }
}

// ========== 窗口规则 ==========
window-rule {
    // 所有窗口的通用规则
    match at-startup=true
    opacity 1.0
}

// 浮动窗口规则
window-rule {
    match app-id="org.gnome.Calculator"
    default-column-width { fixed 350; }
    open-floating true
}

window-rule {
    match app-id="org.gnome.Characters"
    default-column-width { fixed 400; }
    open-floating true
}

window-rule {
    match app-id="org.gnome.FileRoller"
    default-column-width { fixed 600; }
    open-floating true
}

// 图片查看器
window-rule {
    match app-id="org.gnome.eog"
    default-column-width { fixed 800; }
    open-floating true
}

// 系统设置
window-rule {
    match app-id="org.gnome.Settings"
    default-column-width { fixed 900; }
    open-floating true
}

// 火狐浏览器画中画
window-rule {
    match title="Picture-in-Picture"
    default-column-width { fixed 500; }
    open-floating true
}

// ========== 动画配置 ==========
animations {
    // 启用动画
    off false
    
    // 工作区切换动画
    workspace-switch {
        spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
    }
    
    // 窗口打开动画
    window-open {
        duration-ms 150
        curve "ease-out-cubic"
    }
    
    // 窗口关闭动画
    window-close {
        duration-ms 150
        curve "ease-out-cubic"
    }
    
    // 窗口移动动画
    window-movement {
        spring damping-ratio=1.0 stiffness=800 epsilon=0.0001
    }
    
    // 窗口大小调整动画
    window-resize {
        spring damping-ratio=1.0 stiffness=800 epsilon=0.0001
    }
    
    // 水平视图移动
    horizontal-view-movement {
        spring damping-ratio=1.0 stiffness=800 epsilon=0.0001
    }
    
    // 配置通知动画
    config-notification-open-close {
        spring damping-ratio=0.6 stiffness=1000 epsilon=0.001
    }
}

// ========== 手势配置 ==========
gestures {
    // 工作区切换手势
    workspace-swipe-fingers 3
    workspace-swipe-cancel-threshold 0.15
    
    // 4 指滑动切换工作区
    workspace-switch-4f {
        // up down left right
        up { switch-workspace-up; }
        down { switch-workspace-down; }
    }
}

// ========== 其他设置 ==========
// 光标主题
cursor {
    theme "Adwaita"
    size 24
}

// 环境变量设置
environment {
    // QT 主题
    QT_QPA_PLATFORMTHEME "qt5ct"
    
    // 启用 Wayland 支持
    NIXOS_OZONE_WL "1"
    MOZ_ENABLE_WAYLAND "1"
    
    // Java 应用支持
    _JAVA_AWT_WM_NONREPARENTING "1"
    
    // Firefox 硬件加速
    MOZ_WEBRENDER "1"
}

// ========== 调试选项 ==========
debug {
    // 渲染时间检测
    render-drm-device "/dev/dri/renderD128"
    
    // 启用调试输出 (生产环境建议关闭)
    // dbus-interfaces-in-non-session-instances true
    
    // 禁用内置截图UI，使用外部工具
    disable-direct-scanout true
    
    // 启用等待 VBlank (垂直同步)
    wait-for-frame-completion-before-queueing true
}

// ========== 自定义命名工作区 (可选) ==========
// workspace "browser" {
//     name "Browser"
// }
// 
// workspace "code" {
//     name "Code"
// }
// 
// workspace "term" {
//     name "Terminal"
// }

// ========== 屏幕保护程序设置 ==========
screen-transition {
    delay-ms 1000
    kind "crossfade"
}

// ========== 配置结束 ==========
